/* @pollon/state-machine - v1.0.0
* https://github.com/pollon-js/state-machine#readme
* 2020 Francesco Lasaracina. Licensed ISC */
System.register(["@pollon/message-broker"],(function(t){"use strict";var n,e,r,i;return{setters:[function(t){n=t.Event,e=t.Broker,r=t.Publisher,i=t.Subscriber}],execute:function(){function o(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function a(t,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function c(t,n,e){return n&&a(t.prototype,n),e&&a(t,e),t}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,n){return(u=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}function f(t,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):n}function h(t){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var e,r=s(t);if(n){var i=s(this).constructor;e=Reflect.construct(r,arguments,i)}else e=r.apply(this,arguments);return f(this,e)}}function l(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(t)))return;var e=[],r=!0,i=!1,o=void 0;try{for(var a,c=t[Symbol.iterator]();!(r=(a=c.next()).done)&&(e.push(a.value),!n||e.length!==n);r=!0);}catch(t){i=!0,o=t}finally{try{r||null==c.return||c.return()}finally{if(i)throw o}}return e}(t,n)||function(t,n){if(!t)return;if("string"==typeof t)return v(t,n);var e=Object.prototype.toString.call(t).slice(8,-1);"Object"===e&&t.constructor&&(e=t.constructor.name);if("Map"===e||"Set"===e)return Array.from(t);if("Arguments"===e||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return v(t,n)}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function v(t,n){(null==n||n>t.length)&&(n=t.length);for(var e=0,r=new Array(n);e<n;e++)r[e]=t[e];return r}var y=function(t){!function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&u(t,n)}(e,t);var n=h(e);function e(t,r,i){var a;return o(this,e),(a=n.call(this,t)).state=r,a.args=i,a}return e}(n),p=function(t,n,e,r){return function(){var i=t;return r&&r.length>1&&(i=r.pop()),t.publisher.fire(n,new y(n,e,r),i)}},b=function(){function t(n,e,r,i,a){o(this,t),this.name=n,this.from=e,this.to=r,this.state=i,this.context=a}return c(t,[{key:"isActionValid",value:function(){return this.state.isActionValid(this)}},{key:"execute",value:function(){var t=this;if(!this.isActionValid())throw"[State Machine] Invalid action '".concat(this.name,"' called on state: '").concat(this.state.from,"'");if(this.context.isPending())throw"[State Machine] pending transition '".concat(this.context.currentState.from,"'");this.context.pending=!0;for(var n=arguments.length,e=new Array(n),r=0;r<n;r++)e[r]=arguments[r];return Promise.resolve(this).then(p(this.context,m.EVENTS.LEFT,this.state.from)).then(p(this.context,m.EVENTS.ON,this.name,e)).then((function(){var n;n=t.context.currentState.actions[t.name],t.context.currentState=t.context.transitions[n.to]})).then(p(this.context,m.EVENTS.ENTERED,this.to,e)).then((function(){t.context.pending=!1}))}}]),t}(),d=function(){function t(n,e,r){if(o(this,t),this.from=n,this.actions={},e)for(var i=0,a=Object.entries(e);i<a.length;i++){var c=l(a[i],2),s=c[0],u=c[1];this.addAction(s,u,r)}}return c(t,[{key:"addAction",value:function(t,n,e){if(Array.isArray(n))throw new Error("Pollon: [state-machine:invalid] Ambiguous transition '".concat(this.from,"'' -> '").concat(t,"'"));this.actions[t]=new b(t,this.from,n||this.from,this,e)}},{key:"isActionValid",value:function(t){var n=t.name;return!!this.actions[n]}}]),t}(),m=t("StateMachine",function(){function t(n){var i;if(o(this,t),this.transitions={},!(i=n.transitions||{})[n.initial])throw new Error("Pollon: [state-machine:invalid] Invalid initial state '".concat(n.initial,"'"));for(var a=0,c=Object.entries(i);a<c.length;a++){var s=l(c[a],2),u=s[0],f=s[1];this.transitions[u]=new d(u,f,this)}for(var h=0,v=Object.entries(i);h<v.length;h++)for(var y=l(v[h],2)[1],p=0,b=Object.entries(y);p<b.length;p++){var m=l(b[p],2)[1];this.transitions[m]||(this.transitions[m]=new d(m,{},this))}this.currentState=this.transitions[n.initial],this.pending=null,this.Bus=new e,this.publisher=new r(Object.values(t.EVENTS)),this.Bus.addPublisher(this.publisher)}return c(t,null,[{key:"EVENTS",get:function(){return{LEFT:"statemachine.state_leaving",ON:"statemachine.state",ENTERED:"statemachine.state_entered"}}}]),c(t,[{key:"isPending",value:function(){return!!this.pending}},{key:"can",value:function(t){return!!this.currentState.actions[t]}},{key:"on",value:function(t,n,e,r){var o,a;return(o={})[t]={method:function(t,r){if(n==r.state||"*"==n)return e(t,r)},once:!!r},a=new i(o),this.Bus.addSubscriber(a),a}},{key:"off",value:function(t){this.Bus.removeSubscriber(t)}},{key:"handle",value:function(t){for(var n=this,e=arguments.length,r=new Array(e>1?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];return this.can(t)?new Promise((function(e,i){var o;return(o=n.currentState.actions[t]).execute.apply(o,r).then((function(){e()})).catch((function(t){i(t)}))})):Promise.reject("[State Machine] action '".concat(t,"'' forbidden in the current state '").concat(this.currentState.from,"'"))}}]),t}())}}}));
