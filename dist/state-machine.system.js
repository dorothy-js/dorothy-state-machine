/* @pollon/state-machine - v1.0.0
* https://github.com/pollon-js/state-machine#readme
* 2020 Francesco Lasaracina. Licensed ISC */
System.register(["@pollon/message-broker"],(function(t){"use strict";var n,e,i,r;return{setters:[function(t){n=t.Event,e=t.Broker,i=t.Publisher,r=t.Subscriber}],execute:function(){function o(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function a(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function s(t,n,e){return n&&a(t.prototype,n),e&&a(t,e),t}function c(t){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,n){return(u=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}function h(t,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):n}function f(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var e=[],i=!0,r=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(e.push(a.value),!n||e.length!==n);i=!0);}catch(t){r=!0,o=t}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return e}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var l=function(t){function n(t,e,i){var r;return o(this,n),(r=h(this,c(n).call(this,t))).state=e,r.args=i,r}return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&u(t,n)}(n,t),n}(n),v=function(t,n,e,i){return function(){var r=t;return i&&i.length>1&&(r=i.pop()),t.publisher.fire(n,new l(n,e,i),r)}},b=function(){function t(n,e,i,r,a){o(this,t),this.name=n,this.from=e,this.to=i,this.state=r,this.context=a}return s(t,[{key:"isActionValid",value:function(){return this.state.isActionValid(this)}},{key:"execute",value:function(){var t=this;if(!this.isActionValid())throw"[State Machine] Invalid action '".concat(this.name,"' called on state: '").concat(this.state.from,"'");if(this.context.isPending())throw"[State Machine] pending transition '".concat(this.context.currentState.from,"'");this.context.pending=!0;for(var n=arguments.length,e=new Array(n),i=0;i<n;i++)e[i]=arguments[i];return Promise.resolve(this).then(v(this.context,p.EVENTS.LEFT,this.state.from)).then(v(this.context,p.EVENTS.ON,this.name,e)).then((function(){var n;n=t.context.currentState.actions[t.name],t.context.currentState=t.context.transitions[n.to]})).then(v(this.context,p.EVENTS.ENTERED,this.to,e)).then((function(){t.context.pending=!1}))}}]),t}(),y=function(){function t(n,e,i){if(o(this,t),this.from=n,this.actions={},e)for(var r=0,a=Object.entries(e);r<a.length;r++){var s=f(a[r],2),c=s[0],u=s[1];this.addAction(c,u,i)}}return s(t,[{key:"addAction",value:function(t,n,e){if(Array.isArray(n))throw new Error("Pollon: [state-machine:invalid] Ambiguous transition '".concat(this.from,"'' -> '").concat(t,"'"));this.actions[t]=new b(t,this.from,n||this.from,this,e)}},{key:"isActionValid",value:function(t){var n=t.name;return!!this.actions[n]}}]),t}(),p=t("StateMachine",function(){function t(n){var r;if(o(this,t),this.transitions={},!(r=n.transitions||{})[n.initial])throw new Error("Pollon: [state-machine:invalid] Invalid initial state '".concat(n.initial,"'"));for(var a=0,s=Object.entries(r);a<s.length;a++){var c=f(s[a],2),u=c[0],h=c[1];this.transitions[u]=new y(u,h,this)}for(var l=0,v=Object.entries(r);l<v.length;l++)for(var b=f(v[l],2)[1],p=0,d=Object.entries(b);p<d.length;p++){var m=f(d[p],2)[1];this.transitions[m]||(this.transitions[m]=new y(m,{},this))}this.currentState=this.transitions[n.initial],this.pending=null,this.Bus=new e,this.publisher=new i(Object.values(t.EVENTS)),this.Bus.addPublisher(this.publisher)}return s(t,null,[{key:"EVENTS",get:function(){return{LEFT:"statemachine.state_leaving",ON:"statemachine.state",ENTERED:"statemachine.state_entered"}}}]),s(t,[{key:"isPending",value:function(){return!!this.pending}},{key:"can",value:function(t){return!!this.currentState.actions[t]}},{key:"on",value:function(t,n,e,i){var o,a;return(o={})[t]={method:function(t,i){if(n==i.state||"*"==n)return e(t,i)},once:!!i},a=new r(o),this.Bus.addSubscriber(a),a}},{key:"off",value:function(t){this.Bus.removeSubscriber(t)}},{key:"handle",value:function(t){for(var n=this,e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];return this.can(t)?new Promise((function(e,r){var o;return(o=n.currentState.actions[t]).execute.apply(o,i).then((function(){e()})).catch((function(t){r(t)}))})):Promise.reject("[State Machine] action '".concat(t,"'' forbidden in the current state '").concat(this.currentState.from,"'"))}}]),t}())}}}));
