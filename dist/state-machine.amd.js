/* @pollon/state-machine - v1.0.0
* https://github.com/pollon-js/state-machine#readme
* 2020 Francesco Lasaracina. Licensed ISC */
define(["exports","@pollon/message-broker"],(function(t,n){"use strict";function e(t,n){if(!(t instanceof n))throw new TypeError("Cannot call a class as a function")}function i(t,n){for(var e=0;e<n.length;e++){var i=n[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function r(t,n,e){return n&&i(t.prototype,n),e&&i(t,e),t}function o(t){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function a(t,n){return(a=Object.setPrototypeOf||function(t,n){return t.__proto__=n,t})(t,n)}function s(t,n){return!n||"object"!=typeof n&&"function"!=typeof n?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):n}function c(t,n){return function(t){if(Array.isArray(t))return t}(t)||function(t,n){if(!(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t)))return;var e=[],i=!0,r=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(i=(a=s.next()).done)&&(e.push(a.value),!n||e.length!==n);i=!0);}catch(t){r=!0,o=t}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return e}(t,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var u=function(t){function n(t,i,r){var a;return e(this,n),(a=s(this,o(n).call(this,t))).state=i,a.args=r,a}return function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(n&&n.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),n&&a(t,n)}(n,t),n}(n.Event),h=function(t,n,e,i){return function(){var r=t;return i&&i.length>1&&(r=i.pop()),t.publisher.fire(n,new u(n,e,i),r)}},f=function(){function t(n,i,r,o,a){e(this,t),this.name=n,this.from=i,this.to=r,this.state=o,this.context=a}return r(t,[{key:"isActionValid",value:function(){return this.state.isActionValid(this)}},{key:"execute",value:function(){var t=this;if(!this.isActionValid())throw"[State Machine] Invalid action '".concat(this.name,"' called on state: '").concat(this.state.from,"'");if(this.context.isPending())throw"[State Machine] pending transition '".concat(this.context.currentState.from,"'");this.context.pending=!0;for(var n=arguments.length,e=new Array(n),i=0;i<n;i++)e[i]=arguments[i];return Promise.resolve(this).then(h(this.context,v.EVENTS.LEFT,this.state.from)).then(h(this.context,v.EVENTS.ON,this.name,e)).then((function(){var n;n=t.context.currentState.actions[t.name],t.context.currentState=t.context.transitions[n.to]})).then(h(this.context,v.EVENTS.ENTERED,this.to,e)).then((function(){t.context.pending=!1}))}}]),t}(),l=function(){function t(n,i,r){if(e(this,t),this.from=n,this.actions={},i)for(var o=0,a=Object.entries(i);o<a.length;o++){var s=c(a[o],2),u=s[0],h=s[1];this.addAction(u,h,r)}}return r(t,[{key:"addAction",value:function(t,n,e){if(Array.isArray(n))throw new Error("Pollon: [state-machine:invalid] Ambiguous transition '".concat(this.from,"'' -> '").concat(t,"'"));this.actions[t]=new f(t,this.from,n||this.from,this,e)}},{key:"isActionValid",value:function(t){var n=t.name;return!!this.actions[n]}}]),t}(),v=function(){function t(i){var r;if(e(this,t),this.transitions={},!(r=i.transitions||{})[i.initial])throw new Error("Pollon: [state-machine:invalid] Invalid initial state '".concat(i.initial,"'"));for(var o=0,a=Object.entries(r);o<a.length;o++){var s=c(a[o],2),u=s[0],h=s[1];this.transitions[u]=new l(u,h,this)}for(var f=0,v=Object.entries(r);f<v.length;f++)for(var b=c(v[f],2)[1],p=0,d=Object.entries(b);p<d.length;p++){var y=c(d[p],2)[1];this.transitions[y]||(this.transitions[y]=new l(y,{},this))}this.currentState=this.transitions[i.initial],this.pending=null,this.Bus=new n.Broker,this.publisher=new n.Publisher(Object.values(t.EVENTS)),this.Bus.addPublisher(this.publisher)}return r(t,null,[{key:"EVENTS",get:function(){return{LEFT:"statemachine.state_leaving",ON:"statemachine.state",ENTERED:"statemachine.state_entered"}}}]),r(t,[{key:"isPending",value:function(){return!!this.pending}},{key:"can",value:function(t){return!!this.currentState.actions[t]}},{key:"on",value:function(t,e,i,r){var o,a;return(o={})[t]={method:function(t,n){if(e==n.state||"*"==e)return i(t,n)},once:!!r},a=new n.Subscriber(o),this.Bus.addSubscriber(a),a}},{key:"off",value:function(t){this.Bus.removeSubscriber(t)}},{key:"handle",value:function(t){for(var n=this,e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];return this.can(t)?new Promise((function(e,r){var o;return(o=n.currentState.actions[t]).execute.apply(o,i).then((function(){e()})).catch((function(t){r(t)}))})):Promise.reject("[State Machine] action '".concat(t,"'' forbidden in the current state '").concat(this.currentState.from,"'"))}}]),t}();t.StateMachine=v,Object.defineProperty(t,"__esModule",{value:!0})}));
